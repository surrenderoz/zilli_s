<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zillow Bulk Zestimate Scraper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            background-color: #f5f5f7;
            color: #1d1d1f;
        }

        .container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-top: 0;
            color: #006aff;
        }

        .upload-area {
            border: 2px dashed #006aff;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .upload-area:hover {
            background: #f0f7ff;
        }

        button {
            background: #006aff;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #status {
            margin-top: 1rem;
            font-weight: 500;
            min-height: 24px;
        }

        /* Table Styles */
        .results-container {
            margin-top: 2rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: 0.9rem;
        }

        th,
        td {
            padding: 8px 12px;
            border-bottom: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .price {
            font-weight: bold;
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Zillow Zestimates</h1>
        <p>Upload CSV to process properties in real-time.</p>

        <div class="upload-area" id="dropZone">
            <p>Drag & Drop CSV here or Click to Select</p>
            <input type="file" id="fileInput" accept=".csv" style="display: none;">
            <p id="fileName" style="font-weight: bold; margin-top: 10px;"></p>
        </div>

        <button id="processBtn" disabled>Start Processing</button>
        <button id="stopBtn" disabled style="background-color: #d32f2f; margin-left: 10px;">Stop Processing</button>
        <label style="margin-left: 15px; font-weight: bold;">
            Concurrency:
            <input type="number" id="concurrencyInput" value="10" min="1" max="50" style="width: 50px; padding: 5px;">
        </label>
        <div id="status"></div>

        <div class="results-container">
            <table id="resultsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Address</th>
                        <th>Client</th>
                        <th>Email</th>
                        <th>Zillow Address</th>
                        <th>Zestimate</th>
                        <th>Zipcode</th>
                        <th>URL</th>
                        <th>Comment</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="paginationControls"
            style="display: none; justify-content: space-between; align-items: center; margin-top: 1rem;">
            <div>
                <label>Rows per page:
                    <select id="rowsPerPageSelect">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </label>
            </div>
            <div>
                <button id="prevBtn" disabled>Prev</button>
                <span id="pageInfo" style="margin: 0 10px;">Page 1 of 1</span>
                <button id="nextBtn" disabled>Next</button>
            </div>
        </div>

        <div id="downloadSection" style="margin-top: 2rem; text-align: center; display: none;">
            <a id="downloadLink" href="#" target="_blank">
                <button
                    style="background-color: #2e7d32; padding: 10px 20px; color: white; border: none; border-radius: 4px; cursor: pointer;">Download
                    CSV</button>
            </a>
            <a id="downloadLinkXlsx" href="#" target="_blank" style="margin-left: 10px;">
                <button
                    style="background-color: #1a73e8; padding: 10px 20px; color: white; border: none; border-radius: 4px; cursor: pointer;">Download
                    Excel</button>
            </a>
            <button id="deleteSessionBtn"
                style="margin-left: 10px; background-color: #d32f2f; padding: 10px 20px; color: white; border: none; border-radius: 4px; cursor: pointer;">Delete
                Session</button>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const processBtn = document.getElementById('processBtn');
        const stopBtn = document.getElementById('stopBtn');
        const concurrencyInput = document.getElementById('concurrencyInput');
        const fileNameDisplay = document.getElementById('fileName');
        const statusDiv = document.getElementById('status');
        const resultsTable = document.getElementById('resultsTable');
        const tbody = resultsTable.querySelector('tbody');
        const downloadSection = document.getElementById('downloadSection');
        const downloadLink = document.getElementById('downloadLink');
        const downloadLinkXlsx = document.getElementById('downloadLinkXlsx');
        const deleteSessionBtn = document.getElementById('deleteSessionBtn');
        const paginationControls = document.getElementById('paginationControls');
        const rowsPerPageSelect = document.getElementById('rowsPerPageSelect');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');

        let selectedFile = null;
        let currentWs = null;
        let currentUploadId = null;

        // Pagination State
        let allRows = [];
        let currentPage = 1;
        let rowsPerPage = 10;

        // Sorting Helper
        function sortRows(rows) {
            return rows.sort((a, b) => {
                const priceA = parseInt(String(a.zillow_estimated_price || '0').replace(/[^0-9]/g, '') || '0');
                const priceB = parseInt(String(b.zillow_estimated_price || '0').replace(/[^0-9]/g, '') || '0');
                // Descending (High -> Low)
                return priceB - priceA;
            });
        }

        // --- Helpers ---
        function updateStatus(processed, total, isStopped = false) {
            const remaining = total - processed;
            let text = `Processed: ${processed} | Remaining: ${remaining}`;
            if (isStopped) text += ' (Stopped)';
            else if (remaining === 0 && total > 0) text += ' (Complete)';
            else text += ' (Processing...)';
            statusDiv.textContent = text;
        }

        function renderTable() {
            tbody.innerHTML = '';

            // Sort before slice
            sortRows(allRows);

            // Calculate slice
            const totalPages = Math.ceil(allRows.length / rowsPerPage) || 1;
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageRows = allRows.slice(start, end);

            pageRows.forEach(row => {
                const tr = document.createElement('tr');
                // Check if row has error comment (for styling)
                const isError = row.comment && row.comment.toLowerCase().includes('error');
                const commentStyle = isError ? 'color: red; font-weight: bold;' : 'color: red; font-size: 0.8em;';

                tr.innerHTML = `
                     <td>${row.address}</td>
                     <td>${row.client_name || '-'}</td>
                     <td>${row.email}</td>
                     <td>${row.zillow_address || '-'}</td>
                     <td class="price">${row.zillow_estimated_price || '-'}</td>
                     <td>${row.zipcode || '-'}</td>
                     <td>${row.property_url ? `<a href="${row.property_url}" target="_blank">View</a>` : '-'}</td>
                     <td style="${commentStyle}">${row.comment || ''}</td>
                 `;
                tbody.appendChild(tr);
            });

            // Update Controls
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            paginationControls.style.display = 'flex';

            // Enable Download if any rows exist
            if (allRows.length > 0 && currentUploadId) {
                downloadLink.href = `/download/csv/${currentUploadId}`;
                downloadLinkXlsx.href = `/download/xlsx/${currentUploadId}`;
                downloadSection.style.display = 'block';

                // Set Delete Button Handler
                deleteSessionBtn.onclick = async () => {
                    if (confirm('Are you sure you want to delete this session? This action cannot be undone.')) {
                        try {
                            const res = await fetch(`/session/${currentUploadId}`, { method: 'DELETE' });
                            if (res.ok) {
                                localStorage.removeItem('zillow_upload_id');
                                window.location.reload();
                            } else {
                                alert('Failed to delete session');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error deleting session');
                        }
                    }
                };

            } else {
                downloadSection.style.display = 'none';
            }
        }

        // Pagination Events
        rowsPerPageSelect.onchange = (e) => {
            rowsPerPage = parseInt(e.target.value);
            currentPage = 1;
            renderTable();
        };
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        };
        nextBtn.onclick = () => {
            const totalPages = Math.ceil(allRows.length / rowsPerPage) || 1;
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        };

        function connectWs(id, totalRows) {
            if (currentWs) currentWs.close();

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            currentWs = ws;
            currentUploadId = id;

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                console.log('WS Message:', msg);

                if (msg.type === 'row_processed') {
                    console.log('Rendering row:', msg.data.address);
                    allRows.push(msg.data);
                    renderTable();
                    updateStatus(allRows.length, totalRows);
                } else if (msg.type === 'done') {
                    console.log('Done processing');
                    updateStatus(allRows.length, totalRows);
                    renderTable(); // Ensure download logic runs
                    ws.close();
                    processBtn.disabled = false;
                    stopBtn.disabled = true;
                    currentWs = null;
                } else if (msg.type === 'stopped') {
                    console.log('Stopped processing');
                    updateStatus(allRows.length, totalRows, true);
                    renderTable();
                    stopBtn.disabled = true;
                    processBtn.disabled = false;
                } else if (msg.type === 'error') {
                    console.error('WS Error:', msg.message);
                    statusDiv.textContent = 'Error: ' + msg.message;
                }
            };

            ws.onerror = () => {
                statusDiv.textContent = 'WebSocket Error.';
                processBtn.disabled = false;
            };

            return ws;
        }

        // --- Core Logic ---

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFile(e.target.files[0]);
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.background = '#f0f7ff'; };
        dropZone.ondragleave = (e) => { e.preventDefault(); dropZone.style.background = 'transparent'; };
        dropZone.ondrop = (e) => { e.preventDefault(); dropZone.style.background = 'transparent'; handleFile(e.dataTransfer.files[0]); };

        function handleFile(file) {
            if (file && file.name.endsWith('.csv')) {
                selectedFile = file;
                fileNameDisplay.textContent = file.name;
                processBtn.disabled = false;
                statusDiv.textContent = 'Ready to upload.';
            } else {
                alert('Please select a valid CSV file.');
            }
        }

        processBtn.onclick = async () => {
            if (currentWs) currentWs.close();
            if (!selectedFile) return;

            processBtn.disabled = true;
            stopBtn.disabled = false;
            statusDiv.textContent = 'Uploading...';
            allRows = []; // Reset
            currentPage = 1;
            renderTable();
            resultsTable.style.display = 'table';
            downloadSection.style.display = 'none';

            // Auto-clean previous session if exists
            const existingId = localStorage.getItem('zillow_upload_id');
            if (existingId) {
                console.log('Cleaning up previous session:', existingId);
                await fetch(`/session/${existingId}`, { method: 'DELETE' }).catch(err => console.error("Cleanup error:", err));
                localStorage.removeItem('zillow_upload_id');
            }

            const formData = new FormData();
            formData.append('file', selectedFile);

            statusDiv.textContent = 'Uploading...'; // This line is redundant but kept as per instruction's structure

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                // Save for persistence
                localStorage.setItem('zillow_upload_id', data.id);

                statusDiv.textContent = `Uploaded. Processing ${data.total} rows...`;

                const ws = connectWs(data.id, data.total);
                ws.onopen = () => ws.send(JSON.stringify({
                    type: 'start',
                    id: data.id,
                    concurrency: parseInt(concurrencyInput.value) || 10
                }));

            } catch (error) {
                console.error(error);
                statusDiv.textContent = 'Error: ' + error.message;
                processBtn.disabled = false;
            }
        };

        stopBtn.onclick = () => {
            if (currentWs && currentUploadId) {
                currentWs.send(JSON.stringify({ type: 'stop', id: currentUploadId }));
                stopBtn.disabled = true;
                statusDiv.textContent = 'Requesting stop...';
            }
        };

        // Restore Session
        async function restoreSession() {
            const savedId = localStorage.getItem('zillow_upload_id');
            if (!savedId) return;

            try {
                const res = await fetch(`/status/${savedId}`);
                if (!res.ok) throw new Error('Status fetch failed');
                const data = await res.json();

                if (data.error) {
                    localStorage.removeItem('zillow_upload_id');
                    return;
                }

                // Restore UI
                currentUploadId = savedId;
                resultsTable.style.display = 'table';
                allRows = data.rows || [];
                renderTable();
                updateStatus(data.processed, data.total, data.isStopped);

                if (data.isStopped || (data.processed >= data.total && data.total > 0)) {
                    // Done or Stopped
                    processBtn.disabled = false;
                    stopBtn.disabled = true;
                } else {
                    // Resume WS
                    stopBtn.disabled = false;
                    processBtn.disabled = true;

                    const ws = connectWs(savedId, data.total);
                    ws.onopen = () => {
                        // If processing is active, just subscribe.
                        // If stopped/restarted (not processing), send START to resume.
                        const type = data.isProcessing ? 'subscribe' : 'start';
                        if (!data.isProcessing) console.log('Resuming stopped/restarted session...');
                        ws.send(JSON.stringify({
                            type,
                            id: savedId,
                            concurrency: parseInt(concurrencyInput.value) || 10
                        }));
                    };
                }
            } catch (e) {
                console.error("Restore failed:", e);
                localStorage.removeItem('zillow_upload_id');
            }
        }

        window.onload = restoreSession;
    </script>
</body>

</html>